{"version":3,"file":"QuickUndo.min.js","mappings":"AAAAA,EAAE,WACE,SAASC,EAAKC,EAAQC,EAAQC,EAAWC,GAAoB,IACzD,IAAIC,GAAGC,KAAMC,SAAS,QAAQC,KAAK,SAASC,GACxCC,SAAW,CACP,OAAU,OACV,OAAU,OACV,OAAUT,EACV,QAAW,6CAA+CE,EAAY,MAAQD,EAAS,mBAAqBC,EAAY,IAAMD,EAAS,UACvI,KAAQA,EACR,MAASO,GAETN,IAAWO,SAASP,UAAYA,GACpCE,GAAGM,OAAO,QACVZ,EAAEa,KAAK,CACHC,KAAM,OACNC,IAAK,WACLC,KAAML,SACNM,QAAS,SAAUD,GACXA,EAAKE,MAA4B,WAApBF,EAAKE,KAAKC,OACGC,MAAtBJ,EAAKE,KAAKG,SACVf,GAAGM,OAAO,gBAEVN,GAAGM,OAAO,MACVU,WAAW,WAAcC,OAAOC,KAAK,iBAAmBR,EAAKE,KAAKO,SAAW,EAAG,IAE7ET,EAAKE,MAA4B,WAApBF,EAAKE,KAAKC,QAAuBH,EAAKE,KAAKQ,cAAiE,GAAlDV,EAAKE,KAAKQ,YAAYC,QAAQC,QAAQ,SAAiBvB,GACrIC,GAAGM,OAAO,QAAUI,EAAKE,KAAKQ,YAAYG,GAAK,IAAMb,EAAKE,KAAKQ,YAAYI,YAAc,UACzFR,WAAW,WAAcrB,EAAKC,EAAQC,EAAQC,GAAW,EAAO,EAAG,IAC5DY,EAAKe,OAA4B,uEAAnBf,EAAKe,MAAMC,KAChC1B,GAAGM,OAAO,wBAEVN,GAAGM,OAAO,kBACJqB,KAAKC,UAAUlB,IACrBmB,QAAQC,IAAIH,KAAKC,UAAUlB,IAEnC,EACAe,MAAO,WACHzB,GAAGM,OAAO,SACd,GAER,GAAGyB,MAAM,WACL/B,GAAGM,OAAO,WACd,EACJ,CAWA,IAVIN,GAAGgC,OAAOC,OAAOC,aAAelC,GAAGgC,OAAOC,OAAOE,eACjDzC,EAAE,iBAAiB0C,KAAK,WACpBC,KAAKC,UAAYD,KAAKC,UAAUC,QAAQ,KAAM,yEAClD,GACA7C,EAAE,oBAAoB0C,KAAK,WACvBC,KAAKG,QAAU,WACX7C,EAAKK,GAAGgC,OAAOC,OAAOQ,YAAazC,GAAGgC,OAAOC,OAAOC,YAAalC,GAAGgC,OAAOC,OAAOE,YACtF,CACJ,IAE6B,WAA7BnC,GAAGgC,OAAOC,OAAOS,SAAuB,CACxChD,EAAE,oBAAoBiD,OAAO,4EAC7BjD,EAAE,uBAAuB0C,KAAK,WAC1BC,KAAKG,QAAU,WACX,IAAII,EAAOlD,EAAE2C,MAAMQ,QAAQ,wBAAwBC,SAAS,6BAA6B,GAAGF,KACxF/C,EAAS+C,EAAKG,MAAM,cAAc,GAClCjD,EAAY8C,EAAKG,MAAM,mBAAmB,GAC9CpD,EAAKK,GAAGgC,OAAOC,OAAOQ,YAAa5C,EAAQC,EAC/C,CACJ,GAEA,IAAIkD,EAAYtD,EAAE,0CAA0C,GAAGkD,KAC3D9C,GAAa,EACbmD,EAAQ,EACZvD,EAAE0C,KAAK1C,EAAE,8BAA+B,WACpC,GAAI2C,KAAKO,MAAQI,EAEb,OADAlD,EAAYJ,EAAE2C,MAAMQ,QAAQ,MAAM,GAAGK,QAAQC,SACtC,EAEPF,GAER,GACA,IAAIG,EAAWC,SAASC,cAAc,KACtCF,EAASG,UAAY,KAAON,EAAQ,OACpCG,EAASR,KAAO,KAChBQ,EAASZ,QAAU,WACf7C,EAAKK,GAAGgC,OAAOC,OAAOQ,YAAazC,GAAGgC,OAAOC,OAAOuB,gBAAiB1D,EACzE,EACAJ,EAAE,yBAAyBiD,OAAO,KAAKA,OAAOS,GAAUT,OAAO,IACnE,CACA1B,OAAOwC,mBAAqBxC,OAAOwC,oBAAsB,GACzDxC,OAAOwC,mBAAmBC,KAAK,SAAUC,EAAMjD,GAC3ChB,EAAEiE,GAAMC,KAAK,uBAAuBC,QAAQ,6FAC5CnE,EAAEiE,GAAMC,KAAK,+BAA+BxB,KAAK,WAC7CC,KAAKG,QAAU,WACX7C,EAAKe,EAAKoD,QAAQC,OAAQrD,EAAKoD,QAAQE,UAAWtD,EAAKoD,QAAQG,QACnE,CACJ,EACJ,EACJ","sources":["webpack://mwgadgets/./src/QuickUndo/index.js"],"sourcesContent":["$(function () {\r\n    function undo(pageid, undoid, undoafter, ignoreabusefilter = true) {\r\n        new mw.Api().getToken('csrf').then(function(token) {\r\n            ajaxdata = {\r\n                \"action\": \"edit\",\r\n                \"format\": \"json\",\r\n                \"pageid\": pageid,\r\n                \"summary\": '[[User:SaoMikoto/js/QuickUndo.js|快速撤销]]从版本' + undoafter + '到版本' + undoid + '的[[Special:Diff/' + undoafter + '/' + undoid + '|所有编辑]]',\r\n                \"undo\": undoid,\r\n                \"token\": token,\r\n            };\r\n            if (undoafter) ajaxdata.undoafter = undoafter;\r\n            mw.notify('正在操作');\r\n            $.ajax({\r\n                type: \"POST\",\r\n                url: '/api.php',\r\n                data: ajaxdata,\r\n                success: function (data) {\r\n                    if (data.edit && data.edit.result == 'Success') {\r\n                        if (data.edit.nochange != undefined) {\r\n                            mw.notify('这次编辑似乎已被撤销。');\r\n                        } else {\r\n                            mw.notify('完成');\r\n                            setTimeout(function () { window.open('/Special:Diff/' + data.edit.newrevid); }, 0);\r\n                        }\r\n                    } else if (data.edit && data.edit.result == 'Failure' && data.edit.abusefilter && data.edit.abusefilter.actions.indexOf('warn') != -1 && ignoreabusefilter) {\r\n                        mw.notify('遇到过滤器' + data.edit.abusefilter.id + '（' + data.edit.abusefilter.description + '），忽略警告');\r\n                        setTimeout(function () { undo(pageid, undoid, undoafter, false) }, 0);\r\n                    } else if (data.error && data.error.info == 'The edit could not be undone due to conflicting intermediate edits.') {\r\n                        mw.notify('因存在冲突的中间编辑，本编辑不能撤销。');\r\n                    } else {\r\n                        mw.notify('出现未知错误，以下是错误信息:'\r\n                            + JSON.stringify(data));\r\n                        console.log(JSON.stringify(data))\r\n                    }\r\n                },\r\n                error: function () {\r\n                    mw.notify('网络连接出错');\r\n                }\r\n            });\r\n        }).catch(function() {\r\n            mw.notify('获取编辑令牌失败');\r\n        });\r\n    }\r\n    if (mw.config.values.wgDiffNewId || mw.config.values.wgDiffOldId) {\r\n        $('.mw-diff-undo').each(function () {\r\n            this.innerHTML = this.innerHTML.replace(/）$/, '/<a href=\"#.\" title = \"无需确定并忽略过滤器警告\" class=\"quickundo_diff\">快速撤销</a >）')\r\n        });\r\n        $('a.quickundo_diff').each(function () {\r\n            this.onclick = function () {\r\n                undo(mw.config.values.wgArticleId, mw.config.values.wgDiffNewId, mw.config.values.wgDiffOldId);\r\n            }\r\n        });\r\n    }\r\n    if (mw.config.values.wgAction == 'history') {\r\n        $('.mw-history-undo').append('/<a href=\"#.\" title = \"无需确定并忽略过滤器警告\" class=\"quickundo_history\">快速撤销</a >');\r\n        $('a.quickundo_history').each(function () {\r\n            this.onclick = function () {\r\n                var href = $(this).parents('span.mw-history-undo').children('a:not(.quickundo_history)')[0].href;\r\n                var undoid = href.match(/undo=(\\d+)/)[1];\r\n                var undoafter = href.match(/undoafter=(\\d+)/)[1];\r\n                undo(mw.config.values.wgArticleId, undoid, undoafter);\r\n            }\r\n        });\r\n\r\n        var last_user = $('.history-user:first .mw-userlink:first')[0].href;\r\n        var undoafter = -1;\r\n        var times = 0;\r\n        $.each($('.history-user .mw-userlink'), function () {\r\n            if (this.href != last_user) {\r\n                undoafter = $(this).parents('li')[0].dataset.mwRevid;\r\n                return false;\r\n            } else {\r\n                times++;\r\n            }\r\n        });\r\n        var rollback = document.createElement('a');\r\n        rollback.innerText = '回退' + times + '次的编辑';\r\n        rollback.href = '#.';\r\n        rollback.onclick = function () {\r\n            undo(mw.config.values.wgArticleId, mw.config.values.wgCurRevisionId, undoafter);\r\n        }\r\n        $('#pagehistory li:first').append('[').append(rollback).append(']')\r\n    }\r\n    window.QuickDiffExtension = window.QuickDiffExtension || [];\r\n    window.QuickDiffExtension.push(function (that, data) {\r\n        $(that).find('#quick-diff-content').prepend('<input class=\"quick-undo-quick-diff\" title=\"查无需确定并忽略过滤器警告\" type=\"submit\" value=\"快速撤销此编辑\">');\r\n        $(that).find('input.quick-undo-quick-diff').each(function () {\r\n            this.onclick = function () {\r\n                undo(data.compare.fromid, data.compare.fromrevid, data.compare.torevid);\r\n            }\r\n        });\r\n    });\r\n});"],"names":["$","undo","pageid","undoid","undoafter","ignoreabusefilter","mw","Api","getToken","then","token","ajaxdata","notify","ajax","type","url","data","success","edit","result","undefined","nochange","setTimeout","window","open","newrevid","abusefilter","actions","indexOf","id","description","error","info","JSON","stringify","console","log","catch","config","values","wgDiffNewId","wgDiffOldId","each","this","innerHTML","replace","onclick","wgArticleId","wgAction","append","href","parents","children","match","last_user","times","dataset","mwRevid","rollback","document","createElement","innerText","wgCurRevisionId","QuickDiffExtension","push","that","find","prepend","compare","fromid","fromrevid","torevid"],"sourceRoot":""}