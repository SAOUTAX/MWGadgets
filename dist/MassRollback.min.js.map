{"version":3,"file":"MassRollback.min.js","mappings":"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","sources":["webpack://mwgadgets/./src/MassRollback/index.js"],"sourcesContent":["/* TODO:\r\n    1.回退/撤销失败的页面给出控制台以外的提示\r\n    2.为管理员回退提供markbot可选框，无需以flood用户组或URL带bot视为开关\r\n    3.可能不需要连选功能，按住shift可自动连选，但移动设备无shift\r\n    4.使用ooui\r\n*/\r\n\"use strict\";\r\n$.when($.ready, mw.loader.using([\"mediawiki.api\", \"ext.gadget.libOOUIDialog\"])).then(() => {\r\n    if (mw.config.get(\"wgCanonicalSpecialPageName\") !== \"Contributions\") {\r\n        return;\r\n    }\r\n\r\n    $(\".mw-contributions-list li\").each(function () {\r\n        const newChk = document.createElement(\"input\");\r\n        newChk.setAttribute(\"type\", \"checkbox\");\r\n        newChk.setAttribute(\"data-title\", this.getElementsByClassName(\"mw-contributions-title\")[0].innerText);\r\n        newChk.setAttribute(\"data-revid\", this.getAttribute(\"data-mw-revid\"));\r\n        this.prepend(newChk);\r\n    });\r\n\r\n    const $actionsDiv = $('<div>', { id: 'mw-history-revision-actions' }).css({ float: 'right', 'margin-bottom': '1em' });\r\n\r\n    const buttonsConfig = [\r\n        { label: '全选/反选', id: 'mw-checkbox-invert' },\r\n        { label: '连选', id: 'mw-checkbox-between', title: '请勾选需要操作的第一个和最后一个复选框后点击此按钮。' },\r\n        { label: '撤销', id: 'contributions-undo-button', classes: ['mw-ui-progressive'] },\r\n        { label: '回退', id: 'contributions-rollback-button', classes: ['mw-ui-progressive', 'patroller-show'], title: '默认不启用markbotedit权限。' },\r\n        { label: '挂删', id: 'contributions-registerdelete-button', classes: ['mw-ui-progressive', 'patroller-show'] },\r\n        { label: '版本删除', id: 'contributions-revdel-button', classes: ['mw-ui-progressive', 'sysop-show'], title: '默认仅删除内容和摘要。' }\r\n    ];\r\n    $actionsDiv.append(\r\n        ...buttonsConfig.map(cfg => new OO.ui.ButtonWidget(cfg).$element)\r\n    );\r\n\r\n    $('div.mw-htmlform-ooui-wrapper.oo-ui-layout.oo-ui-panelLayout.oo-ui-panelLayout-padded.oo-ui-panelLayout-framed').after($actionsDiv);\r\n\r\n    $(\"#mw-checkbox-invert\").click(() => {\r\n        $(\"li input[type=\\\"checkbox\\\"]\").prop(\"checked\", (_i, ele) => !ele);\r\n    });\r\n    $(\"#mw-checkbox-between\").click(() => {\r\n        const last = $(\".mw-contributions-list input[type=\\\"checkbox\\\"]:checked:last\").parent()[0];\r\n        $(\".mw-contributions-list input[type=\\\"checkbox\\\"]:checked:first\").parent().nextUntil(last).children(\"input[type=\\\"checkbox\\\"]\").prop(\"checked\", true);\r\n    });\r\n\r\n    const api = new mw.Api();\r\n\r\n    $(\"#contributions-rollback-button\").click(async () => {\r\n        const checked = $(\".mw-contributions-list li :checkbox:checked\");\r\n        const reason = await oouiDialog.prompt(`<ul><li>选中了${checked.length}个页面</li><li>批量回退操作的编辑摘要：<code>xxx// MassRollback</code></li><li>空白则使用默认回退摘要，取消则不进行回退</li><li>管理员可自授权机器用户或在URL后添加<code>bot=1</code>以启用markbotedit。</li></ul><hr>请输入回退摘要：`, {\r\n            title: \"批量回退小工具\",\r\n            size: \"medium\",\r\n            required: false,\r\n        });\r\n        if (reason === null) { return; }\r\n        console.log(\"开始回退...\");\r\n        const user = mw.config.get(\"wgRelevantUserName\");\r\n        checked.each(function () {\r\n            const title = this.getAttribute(\"data-title\");\r\n            try {\r\n                api.postWithToken(\"rollback\", {\r\n                    action: \"rollback\",\r\n                    format: \"json\",\r\n                    title: title,\r\n                    user: user,\r\n                    markbot: mw.config.get(\"wgUserGroups\").includes(\"sysop\") && (mw.config.get(\"wgUserGroups\").includes(\"flood\") || document.URL.includes(\"bot=1\")),\r\n                    watchlist: \"nochange\",\r\n                    tags: \"Automation tool\",\r\n                    summary: reason ? `${reason} // MassRollback` : \"// MassRollback\",\r\n                }).then((result) => {\r\n                    console.log(`回退：${title}\\n${result}`);\r\n                });\r\n            } catch (e) {\r\n                console.log(`回退失败：${e}` instanceof Error ? e.stack.split(\"\\n\")[1].trim() : JSON.stringify(e));\r\n            }\r\n        });\r\n    });\r\n\r\n    $(\"#contributions-undo-button\").click(async () => {\r\n        const checked = $(\".mw-contributions-list li :checkbox:checked\");\r\n        const reason = await oouiDialog.prompt(`<ul><li>选中了${checked.length}个页面</li><li>批量撤销操作的编辑摘要：<code>xxx// MassUndo</code></li><li>空白则使用默认撤销摘要，取消则不进行撤销</li></ul><hr>请输入撤销摘要：`, {\r\n            title: \"批量撤销小工具\",\r\n            size: \"medium\",\r\n            required: false,\r\n        });\r\n        if (reason === null) { return; }\r\n        console.log(\"开始撤销...\");\r\n        checked.each(function () {\r\n            const title = this.getAttribute(\"data-title\"),\r\n                revid = this.getAttribute(\"data-revid\");\r\n            try {\r\n                api.postWithToken(\"csrf\", {\r\n                    action: \"edit\",\r\n                    format: \"json\",\r\n                    title: title,\r\n                    undo: revid,\r\n                    tags: \"Automation tool\",\r\n                    bot: mw.config.get(\"wgUserGroups\").includes(\"flood\"),\r\n                    watchlist: \"nochange\",\r\n                    summary: reason ? `${reason} // MassUndo` : \"// MassUndo\",\r\n                }).then((result) => {\r\n                    console.log(`撤销：${title}\\n${result}`);\r\n                });\r\n            } catch (e) {\r\n                console.log(`撤销失败：${e}` instanceof Error ? e.stack.split(\"\\n\")[1].trim() : JSON.stringify(e));\r\n            }\r\n        });\r\n    });\r\n\r\n    $(\"#contributions-registerdelete-button\").click(async () => {\r\n        const checked = $(\".mw-contributions-list li :checkbox:checked\");\r\n        const username = mw.config.get(\"wgUserName\");\r\n        const reason = await oouiDialog.prompt(`<ul><li>选中了${checked.length}个页面</li><li>批量挂删操作的编辑摘要：<code>xxx// MassDelete</code></li><li>空白则使用默认摘要，取消则不进行挂删</li></ul><hr>请输入挂删摘要：`, {\r\n            title: \"批量挂删小工具\",\r\n            size: \"medium\",\r\n            required: false,\r\n        });\r\n        if (reason === null) { return; }\r\n        console.log(\"开始挂删...\");\r\n        checked.each(function () {\r\n            const title = this.getAttribute(\"data-title\");\r\n            try {\r\n                api.postWithToken(\"csrf\", {\r\n                    action: \"edit\",\r\n                    format: \"json\",\r\n                    title: title,\r\n                    text: `<noinclude>{{即将删除|user=${username}|1=${reason}}}</noinclude>`,\r\n                    tags: \"Automation tool\",\r\n                    bot: mw.config.get(\"wgUserGroups\").includes(\"flood\"),\r\n                    watchlist: \"nochange\",\r\n                    summary: reason ? `${reason} // MassDelete` : \"// MassDelete\",\r\n                }).then((result) => {\r\n                    console.log(`挂删：${title}\\n${result}`);\r\n                });\r\n            } catch (e) {\r\n                console.log(`挂删失败：${e}` instanceof Error ? e.stack.split(\"\\n\")[1].trim() : JSON.stringify(e));\r\n            }\r\n        });\r\n    });\r\n\r\n    $(\"#contributions-revdel-button\").click(async () => {\r\n        const checked = $(\".mw-contributions-list li :checkbox:checked\");\r\n        const reason = await oouiDialog.prompt(`<ul><li>选中了${checked.length}个页面，将删除版本内容和编辑摘要</li><li>批量版本删除的原因：<code>xxx// MassRevisionDelete</code></li><li>空白则使用默认原因，取消则不进行版本删除</li></ul><hr>请输入版本删除原因：`, {\r\n            title: \"批量版本删除小工具\",\r\n            size: \"medium\",\r\n            required: false,\r\n        });\r\n        if (reason === null) { return; }\r\n        console.log(\"开始版本删除...\");\r\n        checked.each(function () {\r\n            const title = this.getAttribute(\"data-title\"),\r\n                revid = this.getAttribute(\"data-revid\");\r\n            try {\r\n                api.postWithToken(\"csrf\", {\r\n                    action: \"revisiondelete\",\r\n                    format: \"json\",\r\n                    type: \"revision\",\r\n                    target: title,\r\n                    ids: revid,\r\n                    tags: \"Automation tool\",\r\n                    hide: \"comment|content\",\r\n                    reason: reason ? `${reason} // MassRevisionDelete` : \"// MassRevisionDelete\",\r\n                }).then((result) => {\r\n                    console.log(`版本删除：${title}\\n${result}`);\r\n                });\r\n            } catch (e) {\r\n                console.log(`版本删除失败：${e}` instanceof Error ? e.stack.split(\"\\n\")[1].trim() : JSON.stringify(e));\r\n            }\r\n        });\r\n    });\r\n});"],"names":["$","when","ready","mw","loader","using","then","config","get","each","newChk","document","createElement","setAttribute","this","getElementsByClassName","innerText","getAttribute","prepend","$actionsDiv","id","css","float","append","label","title","classes","map","cfg","OO","ui","ButtonWidget","$element","after","click","prop","_i","ele","last","parent","nextUntil","children","api","Api","async","checked","reason","oouiDialog","prompt","length","size","required","console","log","user","postWithToken","action","format","markbot","includes","URL","watchlist","tags","summary","result","e","Error","stack","split","trim","JSON","stringify","revid","undo","bot","username","text","type","target","ids","hide"],"sourceRoot":""}